# Form Builder Bug Fixes

## Issue: Failed to Load Form Error

### Problem
When trying to edit an existing form in the Visual Form Builder, users encountered an error:
```
Failed to load form: Failed to load form
```

The server logs showed:
```
AttributeError: 'FormField' object has no attribute 'prefill_source_id'. Did you mean: 'prefill_source'?
```

### Root Cause
The `form_builder_views.py` was using incorrect field names when accessing the FormField model:

1. **Prefill Source**: Tried to access `field.prefill_source_id` but the actual field is `field.prefill_source_config_id` (ForeignKey to PrefillSource model)
2. **Conditional Field**: Tried to access `field.show_if_field_id` but the actual field is `field.show_if_field` (SlugField)
3. **Template URL**: The template was trying to access `form_definition.id` even when `form_definition` was `None` for new forms

### Files Fixed

#### 1. `django_forms_workflows/form_builder_views.py`

**In `form_builder_load()` function (line 67-97):**
- Changed `'prefill_source_id': field.prefill_source_id` to `'prefill_source_id': field.prefill_source_config_id`
- Removed `'prefill_source_config': field.prefill_source_config or {}` (not needed)
- Changed `'show_if_field': field.show_if_field_id` to `'show_if_field': field.show_if_field`

**In `form_builder_save()` function (line 182-197):**
- Changed `'prefill_source_id': field_data.get('prefill_source_id')` to `'prefill_source_config_id': field_data.get('prefill_source_id')`
- Removed `'prefill_source_config': field_data.get('prefill_source_config', {})` (not needed)

**In `form_builder_save()` function (line 210-215):**
- Changed `'show_if_field_id': conditional.get('show_if_field')` to `'show_if_field': conditional.get('show_if_field', '')`

#### 2. `django_forms_workflows/templates/admin/django_forms_workflows/form_builder.html`

**In JavaScript initialization (line 389-397):**
```javascript
// Before:
apiUrls: {
    load: "{% url 'admin:form_builder_api_load' 0 %}".replace('/0/', '/{{ form_definition.id }}/'),
    save: "{% url 'admin:form_builder_api_save' %}",
    preview: "{% url 'admin:form_builder_api_preview' %}"
},

// After:
apiUrls: {
    {% if form_definition %}
    load: "{% url 'admin:form_builder_api_load' form_definition.id %}",
    {% else %}
    load: null,
    {% endif %}
    save: "{% url 'admin:form_builder_api_save' %}",
    preview: "{% url 'admin:form_builder_api_preview' %}"
},
```

#### 3. `django_forms_workflows/static/django_forms_workflows/js/form-builder.js`

**In `init()` function (line 18-27):**
```javascript
// Before:
if (!this.config.isNew && this.config.formId) {
    this.loadForm();
}

// After:
if (!this.config.isNew && this.config.formId && this.config.apiUrls.load) {
    this.loadForm();
}
```

### Model Field Reference

For future reference, here are the correct field names in the `FormField` model:

**Prefill Configuration:**
- `prefill_source` - CharField (deprecated legacy field)
- `prefill_source_config` - ForeignKey to PrefillSource model
- `prefill_source_config_id` - The ID of the related PrefillSource (auto-generated by Django)

**Conditional Display:**
- `show_if_field` - SlugField (the field name to check)
- `show_if_value` - CharField (the value to match)

### Testing

After these fixes, the form builder should:
1. ✅ Load existing forms without errors
2. ✅ Display all field properties correctly
3. ✅ Save prefill source selections
4. ✅ Save conditional display settings
5. ✅ Work for both new and existing forms

### How to Test

1. **Create a new form:**
   - Go to Django Admin → Form Definitions
   - Click "Add Form Definition"
   - Fill in basic details and save
   - Click "Open Visual Form Builder"
   - Should open without errors

2. **Edit an existing form:**
   - Go to Django Admin → Form Definitions
   - Click on an existing form
   - Click "Open Visual Form Builder"
   - Should load the form with all fields displayed

3. **Add a field with prefill:**
   - Drag a field to the canvas
   - Click Edit
   - Select a prefill source from dropdown
   - Save field
   - Save form
   - Reload - prefill source should be preserved

4. **Test conditional fields:**
   - Add two fields
   - Edit the second field
   - Set "Show if field" to the first field's name
   - Set "Show if value" to a test value
   - Save and verify

### Related Issues

This fix resolves:
- Form builder not loading existing forms
- Prefill sources not being saved/loaded correctly
- Conditional display settings not being saved/loaded correctly
- Template errors when creating new forms

### Prevention

To prevent similar issues in the future:
1. Always check the actual model field names before accessing them
2. Use Django's `_id` suffix for ForeignKey IDs
3. Test both create and edit flows
4. Add proper error handling and logging
5. Consider adding unit tests for API endpoints

